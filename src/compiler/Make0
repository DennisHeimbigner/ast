W=-Wd

#TEST=-I . -I./testdata1 t.proto
#TEST=-I./testdata1 addressbook.proto
TEST=-I. t.proto


TOPDIR=d:/IdeaProjects/ast/src/compiler

PARSER=ProtobufParser.java

GRAMMAR=protobuf.y

SRC=\
    ProtobufActions.java ProtobufLexer.java $(PARSER) AST.java \
    Semantics.java AuxFcns.java Printer.java Debug.java  \
    ASTFactory.java ASTFactoryDefault.java \
    Generator.java \
    Getopt.java LongOpt.java \
    ASTDefault.java \
    CGenerator.java

COMPILERPATH=classes/unidate/protobuf/ast/compiler

CLASSES=$(SRC:%.java=$(COMPILERPATH)/%.class)

BUILDDIR=classes

.PHONEY: compile test

all: test

clean::
	rm -f  $(PARSER) Protobuf.output
	rm -fr $(BUILDDIR)

compile: $(BUILDDIR) $(SRC) 
	javac -d $(BUILDDIR) $(SRC)

$(PARSER): $(GRAMMAR)
	rm -f ./tmp 
	bison -v -t -L Java $(GRAMMAR) -o ./$(PARSER)

# The sed operations are to fix some bugs in the generated java code
#	bison -v -t -L Java $(GRAMMAR) -o ./tmp
#	sed -e "s/(null,\ null)/(new Position())/" -e "s/public class Location/static public class Location/" <./tmp >$(PARSER)	

$(BUILDDIR):
	mkdir $(BUILDDIR)

test: compile
	javac -d $(BUILDDIR) -classpath $(BUILDDIR) Main.java
	java -cp $(BUILDDIR) Main ${W} $(TEST)

fix::
	for f in $(SRC) ; do \
	    sed -e 's/ast.protobuf/unidata.protobuf.ast/g'  <save/$$f >./$$f ; \
	done
