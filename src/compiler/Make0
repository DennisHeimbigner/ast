# Define how to build the parser(s)

TEST=descriptor.proto

PARSER=ProtobufParser.java

GRAMMAR=protobuf.y

SRC=\
    ProtobufActions.java ProtobufLexer.java $(PARSER) AST.java \
    Semantics.java Util.java Printer.java Debug.java  \
    ASTFactory.java ASTFactoryDefault.java \
    Generator.java CmdLineParser.java


COMPILERPATH=classes/unidate/protobuf/ast/compiler

CLASSES=$(SRC:%.java=$(COMPILERPATH)/%.class)

BUILDDIR=classes

.PHONEY: compile test

all: test

clean::
	rm -f  $(PARSER) Protobuf.output
	rm -fr $(BUILDDIR)

compile: $(BUILDDIR) $(SRC) 
	javac -d $(BUILDDIR) $(SRC)

# The sed operations are to fix some bugs in the generated java code
$(PARSER): $(GRAMMAR)
	rm -f ./tmp 
	bison -v -t -L java $(GRAMMAR) -o ./tmp
	sed -e "s/(null,\ null)/(new Position())/" -e "s/public class Location/static public class Location/" <./tmp >$(PARSER)	

$(BUILDDIR):
	mkdir $(BUILDDIR)

test: compile
	javac -d $(BUILDDIR) -classpath $(BUILDDIR) Main.java
	java -cp $(BUILDDIR) Main -D $(TEST)

fix::
	for f in $(SRC) ; do \
	    sed -e 's/ast.protobuf/unidata.protobuf.ast/g'  <save/$$f >./$$f ; \
	done
